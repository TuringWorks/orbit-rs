syntax = "proto3";

package orbit.consensus;

// Raft consensus gRPC service definition
service RaftConsensus {
  // Request vote RPC - used during leader election
  rpc RequestVote(VoteRequestProto) returns (VoteResponseProto);

  // Append entries RPC - used for log replication and heartbeats
  rpc AppendEntries(AppendEntriesRequestProto) returns (AppendEntriesResponseProto);
}

// Vote request message
message VoteRequestProto {
  // Candidate's term
  uint64 term = 1;

  // Candidate requesting vote
  string candidate_id = 2;

  // Index of candidate's last log entry
  uint64 last_log_index = 3;

  // Term of candidate's last log entry
  uint64 last_log_term = 4;
}

// Vote response message
message VoteResponseProto {
  // Current term, for candidate to update itself
  uint64 term = 1;

  // True if candidate received vote
  bool vote_granted = 2;

  // ID of the voter node
  string voter_id = 3;
}

// Append entries request message
message AppendEntriesRequestProto {
  // Leader's term
  uint64 term = 1;

  // Leader's ID (so follower can redirect clients)
  string leader_id = 2;

  // Index of log entry immediately preceding new ones
  uint64 prev_log_index = 3;

  // Term of prev_log_index entry
  uint64 prev_log_term = 4;

  // Log entries to store (empty for heartbeat)
  repeated LogEntryProto entries = 5;

  // Leader's commit index
  uint64 leader_commit = 6;
}

// Append entries response message
message AppendEntriesResponseProto {
  // Current term, for leader to update itself
  uint64 term = 1;

  // True if follower contained entry matching prev_log_index and prev_log_term
  bool success = 2;

  // ID of the follower node
  string follower_id = 3;

  // Last log index of the follower
  uint64 last_log_index = 4;
}

// Log entry message
message LogEntryProto {
  // Term when entry was received by leader
  uint64 term = 1;

  // Index position in the log
  uint64 index = 2;

  // Command for state machine (JSON-serialized)
  string command = 3;

  // Timestamp when entry was created (milliseconds since epoch)
  uint64 timestamp = 4;
}
